# é¡¹ç›®æ€»ç»“

## ğŸ“ é¡¹ç›®ç»“æ„

```
stock/
â”œâ”€â”€ cli.py                    # CLI å‘½ä»¤è¡Œå·¥å…·ï¼ˆä¸»å…¥å£ï¼‰
â”œâ”€â”€ verify.py                 # é¡¹ç›®éªŒè¯è„šæœ¬
â”œâ”€â”€ start.sh / start.bat      # å¿«é€Ÿå¯åŠ¨è„šæœ¬
â”œâ”€â”€ setup.py                  # å®‰è£…é…ç½®
â”œâ”€â”€ requirements.txt          # ä¾èµ–åˆ—è¡¨
â”œâ”€â”€ config.yaml.example       # é…ç½®æ¨¡æ¿
â”œâ”€â”€ config.yaml              # é…ç½®æ–‡ä»¶ï¼ˆéœ€åˆ›å»ºï¼‰
â”œâ”€â”€ README.md                # å®Œæ•´æ–‡æ¡£
â”œâ”€â”€ QUICKSTART.md            # å¿«é€Ÿå¼€å§‹æŒ‡å—
â”œâ”€â”€ .gitignore               # Git å¿½ç•¥æ–‡ä»¶
â”‚
â””â”€â”€ stock_analyzer/          # ä¸»åŒ…
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ config.py            # é…ç½®ç®¡ç†
    â”‚
    â”œâ”€â”€ models/              # æ•°æ®åº“æ¨¡å‹
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â””â”€â”€ stock.py         # è‚¡ç¥¨è¡¨æ¨¡å‹
    â”‚
    â”œâ”€â”€ services/            # ä¸šåŠ¡æœåŠ¡
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ database.py      # æ•°æ®åº“æ“ä½œ
    â”‚   â”œâ”€â”€ data_fetcher.py  # æ•°æ®è·å–ï¼ˆakshareï¼‰
    â”‚   â””â”€â”€ scheduler.py     # å®šæ—¶ä»»åŠ¡
    â”‚
    â”œâ”€â”€ tools/               # LLM å·¥å…·
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â””â”€â”€ stock_tools.py   # è‚¡ç¥¨æŸ¥è¯¢å·¥å…·å®šä¹‰
    â”‚
    â”œâ”€â”€ api/                 # API æœåŠ¡
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ server.py        # FastAPI æœåŠ¡ç«¯
    â”‚   â””â”€â”€ llm_handler.py   # LLM å¤„ç†å™¨
    â”‚
    â””â”€â”€ web/                 # Web ç•Œé¢
        â”œâ”€â”€ __init__.py
        â””â”€â”€ index.html       # èŠå¤©ç•Œé¢
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. æ•°æ®è·å– (services/data_fetcher.py)
- âœ… ä½¿ç”¨ akshare è·å–Aè‚¡å®æ—¶æ•°æ®
- âœ… è·å–è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯ï¼ˆä»£ç ã€åç§°ã€è¡Œä¸šç­‰ï¼‰
- âœ… è·å–è´¢åŠ¡æŒ‡æ ‡ï¼ˆå¸‚ç›ˆç‡ã€å¸‚å‡€ç‡ã€ROEç­‰ï¼‰
- âœ… è·å–æ¯æ—¥è¡Œæƒ…ï¼ˆä»·æ ¼ã€æˆäº¤é‡ã€æ¢æ‰‹ç‡ç­‰ï¼‰
- âœ… è·å–å†å²æ•°æ®

### 2. æ•°æ®å­˜å‚¨ (models/stock.py, services/database.py)
- âœ… è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯è¡¨ (stocks)
- âœ… æ¯æ—¥è¡Œæƒ…è¡¨ (stock_daily)
- âœ… æ”¯æŒ SQLiteã€MySQLã€PostgreSQL
- âœ… è‡ªåŠ¨åˆ›å»ºè¡¨ç»“æ„
- âœ… æ•°æ® upsert æ“ä½œï¼ˆæ’å…¥æˆ–æ›´æ–°ï¼‰
- âœ… å¤šç§æŸ¥è¯¢æ¥å£ï¼ˆæœç´¢ã€ç­›é€‰ã€å†å²ï¼‰

### 3. å®šæ—¶æ›´æ–° (services/scheduler.py)
- âœ… ä½¿ç”¨ APScheduler å®šæ—¶ä»»åŠ¡
- âœ… æ¯æ—¥è‡ªåŠ¨æ›´æ–°è‚¡ç¥¨æ•°æ®
- âœ… å¯é…ç½®æ›´æ–°æ—¶é—´
- âœ… å¯åŠ¨æ—¶æ›´æ–°é€‰é¡¹
- âœ… æ‰‹åŠ¨è§¦å‘æ›´æ–°

### 4. LLM é›†æˆ (tools/stock_tools.py, api/llm_handler.py)
- âœ… æ”¯æŒ OpenAI GPT-4
- âœ… æ”¯æŒ Anthropic Claude
- âœ… æ”¯æŒ Ollama æœ¬åœ°æ¨¡å‹
- âœ… Function Calling å·¥å…·å®šä¹‰
- âœ… 5ä¸ªè‚¡ç¥¨æŸ¥è¯¢å·¥å…·ï¼š
  - search_stock: æœç´¢è‚¡ç¥¨
  - get_stock_detail: è·å–è¯¦æƒ…
  - get_stock_history: è·å–å†å²
  - filter_stocks: æ¡ä»¶ç­›é€‰
  - get_database_stats: ç»Ÿè®¡ä¿¡æ¯

### 5. API æœåŠ¡ (api/server.py)
- âœ… FastAPI REST API
- âœ… è‡ªåŠ¨ API æ–‡æ¡£ (/docs)
- âœ… CORS æ”¯æŒ
- âœ… è‚¡ç¥¨æŸ¥è¯¢æ¥å£
- âœ… LLM å¯¹è¯æ¥å£
- âœ… æ•°æ®æ›´æ–°æ¥å£
- âœ… ç»Ÿè®¡ä¿¡æ¯æ¥å£

### 6. CLI å·¥å…· (cli.py)
- âœ… ä½¿ç”¨ Typer å®ç°
- âœ… server å‘½ä»¤ï¼šå¯åŠ¨æœåŠ¡ç«¯
- âœ… client å‘½ä»¤ï¼šäº¤äº’å¼å¯¹è¯
- âœ… update å‘½ä»¤ï¼šæ‰‹åŠ¨æ›´æ–°æ•°æ®
- âœ… stats å‘½ä»¤ï¼šæŸ¥çœ‹ç»Ÿè®¡
- âœ… search å‘½ä»¤ï¼šæœç´¢è‚¡ç¥¨
- âœ… init-config å‘½ä»¤ï¼šåˆå§‹åŒ–é…ç½®

### 7. Web ç•Œé¢ (web/index.html)
- âœ… ç°ä»£åŒ–èŠå¤©ç•Œé¢
- âœ… å®æ—¶ç»Ÿè®¡æ˜¾ç¤º
- âœ… ç¤ºä¾‹é—®é¢˜å¿«æ·æŒ‰é’®
- âœ… å“åº”å¼è®¾è®¡
- âœ… åŠ è½½åŠ¨ç”»
- âœ… æ¶ˆæ¯æ ¼å¼åŒ–

### 8. é…ç½®ç®¡ç† (config.py)
- âœ… YAML é…ç½®æ–‡ä»¶
- âœ… Pydantic æ•°æ®éªŒè¯
- âœ… æ•°æ®åº“é…ç½®
- âœ… LLM é…ç½®
- âœ… è°ƒåº¦é…ç½®
- âœ… API é…ç½®

## ğŸ”§ æŠ€æœ¯æ ˆ

| ç±»åˆ« | æŠ€æœ¯ | ç”¨é€” |
|------|------|------|
| æ•°æ®è·å– | akshare | Aè‚¡æ•°æ®æº |
| æ•°æ®å¤„ç† | pandas | æ•°æ®æ¸…æ´—å’Œè½¬æ¢ |
| æ•°æ®åº“ | SQLAlchemy | ORM æ¡†æ¶ |
| API æ¡†æ¶ | FastAPI | REST API æœåŠ¡ |
| Web æœåŠ¡å™¨ | Uvicorn | ASGI æœåŠ¡å™¨ |
| CLI å·¥å…· | Typer | å‘½ä»¤è¡Œç•Œé¢ |
| ä»»åŠ¡è°ƒåº¦ | APScheduler | å®šæ—¶ä»»åŠ¡ |
| LLM | OpenAI/Anthropic/Ollama | å¤§æ¨¡å‹ |
| æ•°æ®éªŒè¯ | Pydantic | é…ç½®å’Œæ•°æ®éªŒè¯ |
| é…ç½® | PyYAML | YAML é…ç½®è§£æ |

## ğŸ“Š æ•°æ®æ¨¡å‹

### Stock (è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯)
- code: è‚¡ç¥¨ä»£ç  (ä¸»é”®)
- name: è‚¡ç¥¨åç§°
- market: å¸‚åœº (SH/SZ)
- industry: è¡Œä¸š
- list_date: ä¸Šå¸‚æ—¥æœŸ
- total_assets: æ€»èµ„äº§
- net_assets: å‡€èµ„äº§
- pe_ratio: å¸‚ç›ˆç‡
- pb_ratio: å¸‚å‡€ç‡
- roe: å‡€èµ„äº§æ”¶ç›Šç‡
- total_market_cap: æ€»å¸‚å€¼
- circulating_market_cap: æµé€šå¸‚å€¼
- turnover_rate: æ¢æ‰‹ç‡
- updated_at: æ›´æ–°æ—¶é—´

### StockDaily (æ¯æ—¥è¡Œæƒ…)
- code: è‚¡ç¥¨ä»£ç 
- trade_date: äº¤æ˜“æ—¥æœŸ
- open/close/high/low: ä»·æ ¼
- volume: æˆäº¤é‡
- amount: æˆäº¤é¢
- change: æ¶¨è·Œé¢
- pct_change: æ¶¨è·Œå¹…
- total_market_cap: æ€»å¸‚å€¼
- circulating_market_cap: æµé€šå¸‚å€¼
- turnover_rate: æ¢æ‰‹ç‡
- created_at: åˆ›å»ºæ—¶é—´

## ğŸš€ éƒ¨ç½²æ–¹å¼

### å¼€å‘ç¯å¢ƒ
```bash
# ç›´æ¥è¿è¡Œ
python cli.py server

# å¼€å‘æ¨¡å¼ï¼ˆè‡ªåŠ¨é‡è½½ï¼‰
python cli.py server --reload
```

### ç”Ÿäº§ç¯å¢ƒ
```bash
# ä½¿ç”¨ gunicorn
gunicorn stock_analyzer.api.server:app -w 4 -k uvicorn.workers.UvicornWorker

# ä½¿ç”¨ systemd æœåŠ¡
# åˆ›å»º /etc/systemd/system/stock-analyzer.service
```

### Docker éƒ¨ç½²
```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY . .
RUN pip install -r requirements.txt
CMD ["python", "cli.py", "server"]
```

## ğŸ¨ è‡ªå®šä¹‰å’Œæ‰©å±•

### æ·»åŠ æ–°çš„æŸ¥è¯¢å·¥å…·
1. åœ¨ `services/database.py` æ·»åŠ æŸ¥è¯¢æ–¹æ³•
2. åœ¨ `tools/stock_tools.py` æ·»åŠ å·¥å…·å‡½æ•°
3. åœ¨ `get_stock_tools_definitions()` æ·»åŠ å·¥å…·å®šä¹‰

### æ”¯æŒæ–°çš„ LLM
1. åœ¨ `api/llm_handler.py` æ·»åŠ æ–°çš„åˆå§‹åŒ–æ–¹æ³•
2. å®ç°å¯¹åº”çš„ chat æ–¹æ³•
3. åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  provider é€‰é¡¹

### æ·»åŠ æ–°çš„æ•°æ®æº
1. åœ¨ `services/data_fetcher.py` æ·»åŠ è·å–æ–¹æ³•
2. åœ¨ `models/stock.py` æ‰©å±•æ•°æ®æ¨¡å‹
3. åœ¨ `services/scheduler.py` æ·»åŠ æ›´æ–°ä»»åŠ¡

## ğŸ“ é…ç½®ç¤ºä¾‹

### å®Œæ•´é…ç½®
```yaml
database:
  url: "sqlite:///./stock_data.db"

llm:
  provider: "openai"
  api_key: "sk-xxx"
  base_url: "https://api.openai.com/v1"
  model: "gpt-4-turbo-preview"

update_schedule:
  daily_update_time: "16:00"
  auto_update: true
  update_on_start: false

api:
  host: "0.0.0.0"
  port: 8000
  reload: false

web:
  title: "Aè‚¡æ•°æ®åˆ†æåŠ©æ‰‹"
  port: 8501
```

## ğŸ” å®‰å…¨æ³¨æ„äº‹é¡¹

1. **API Key ä¿æŠ¤**: ä¸è¦å°† config.yaml æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
2. **æ•°æ®åº“å®‰å…¨**: ä½¿ç”¨å¼ºå¯†ç ï¼Œé™åˆ¶è®¿é—®æƒé™
3. **API è®¿é—®æ§åˆ¶**: ç”Ÿäº§ç¯å¢ƒå»ºè®®æ·»åŠ èº«ä»½è®¤è¯
4. **HTTPS**: ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ HTTPS
5. **è¾“å…¥éªŒè¯**: æ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½ç»è¿‡éªŒè¯

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ•°æ®åº“ç´¢å¼•**: å·²ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
2. **æ‰¹é‡æ“ä½œ**: æ•°æ®æ›´æ–°ä½¿ç”¨æ‰¹é‡æäº¤
3. **ç¼“å­˜**: å¯ä»¥æ·»åŠ  Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®
4. **å¼‚æ­¥**: API æ¥å£ä½¿ç”¨å¼‚æ­¥å¤„ç†
5. **è¿æ¥æ± **: æ•°æ®åº“è¿æ¥æ± é…ç½®

## ğŸ› å·²çŸ¥é—®é¢˜

1. é¦–æ¬¡æ•°æ®æ›´æ–°æ—¶é—´è¾ƒé•¿ï¼ˆå¯èƒ½éœ€è¦20-30åˆ†é’Ÿï¼‰
2. akshare æ•°æ®è·å–ä¾èµ–ç½‘ç»œï¼Œå¯èƒ½å¶å°”å¤±è´¥
3. éƒ¨åˆ†è‚¡ç¥¨å¯èƒ½æ²¡æœ‰å®Œæ•´çš„è´¢åŠ¡æ•°æ®
4. LLM å“åº”æ—¶é—´å–å†³äºæ¨¡å‹å’Œç½‘ç»œ

## ğŸ”® æœªæ¥æ”¹è¿›

- [ ] æ·»åŠ æŠ€æœ¯æŒ‡æ ‡è®¡ç®—ï¼ˆMAã€MACDã€RSIç­‰ï¼‰
- [ ] æ”¯æŒè‚¡ç¥¨å¯¹æ¯”åˆ†æ
- [ ] æ·»åŠ æ•°æ®å¯è§†åŒ–å›¾è¡¨
- [ ] æ”¯æŒå®æ—¶è¡Œæƒ…æ¨é€ï¼ˆWebSocketï¼‰
- [ ] æ·»åŠ ç”¨æˆ·ç³»ç»Ÿå’Œæƒé™ç®¡ç†
- [ ] æ”¯æŒè‡ªå®šä¹‰é€‰è‚¡ç­–ç•¥
- [ ] æ·»åŠ å›æµ‹åŠŸèƒ½
- [ ] ç§»åŠ¨ç«¯é€‚é…

## ğŸ“ æ”¯æŒ

- æ–‡æ¡£ï¼šREADME.md, QUICKSTART.md
- é—®é¢˜ï¼šæäº¤ Issue
- è®¨è®ºï¼šGitHub Discussions

---

**é¡¹ç›®å®Œæˆæ—¥æœŸ**: 2025-11-06
**ç‰ˆæœ¬**: 1.0.0
